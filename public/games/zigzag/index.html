<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZigZag - Hyper Casual</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #a9cce3;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
            touch-action: none;
        }

        #ui {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            pointer-events: none;
            z-index: 10;
        }

        #score {
            font-size: 64px;
            font-weight: 800;
            text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.1);
        }

        #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            display: none;
            z-index: 20;
            min-width: 200px;
        }

        h1 {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        p {
            color: #666;
            margin: 0 0 20px 0;
            font-size: 16px;
        }

        #final-score {
            color: #e74c3c;
            font-weight: bold;
            font-size: 24px;
        }

        button {
            background: #3498db;
            border: none;
            padding: 15px 40px;
            color: white;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #2980b9;
        }
    </style>
</head>

<body>
    <div id="ui">
        <div id="score">0</div>
    </div>
    <div id="game-over">
        <h1>GAME OVER</h1>
        <p>Score: <span id="final-score">0</span></p>
        <button onclick="location.reload()">RETRY</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        class AudioManager {
            constructor() { this.ctx = null; }
            init() {
                if (!this.ctx) {
                    try {
                        const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                        if (AudioContextClass) this.ctx = new AudioContextClass();
                    } catch (e) { }
                }
                if (this.ctx && this.ctx.state === 'suspended') this.ctx.resume();
            }
            playNote(freq, type, duration = 0.1, volume = 0.1) {
                this.init();
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.frequency.value = freq;
                osc.type = type;
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                gain.gain.value = volume;
                osc.start();
                gain.gain.exponentialRampToValueAtTime(0.00001, this.ctx.currentTime + duration);
                osc.stop(this.ctx.currentTime + duration);
            }
        }
        const audio = new AudioManager();

        const PLATFORM_SIZE = 3, BALL_RADIUS = 0.5, BALL_SPEED_BASE = 0.15;
        let scene, camera, renderer, ball;
        let platforms = [], crystals = [], clouds = [], score = 0, gameState = 'START';
        let direction = 'x', speed = BALL_SPEED_BASE, lastPlatformPos = { x: 0, y: 0, z: 0 };
        let targetCameraPos = { x: 0, y: 0, z: 0 };

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xa9cce3);
            scene.fog = new THREE.Fog(0xa9cce3, 20, 60);

            const aspect = window.innerWidth / window.innerHeight;
            const d = 20;
            camera = new THREE.OrthographicCamera(-d * aspect, d * aspect, d, -d, 1, 1000);
            camera.position.set(20, 20, 20);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const dl = new THREE.DirectionalLight(0xffffff, 0.7);
            dl.position.set(20, 50, 30);
            dl.castShadow = true;
            scene.add(dl);

            initClouds();
            createBall();
            createPlatform(0, 0, 0);
            for (let i = 0; i < 20; i++) spawnNextPlatform();

            resize();
            animate();
            window.parent.postMessage({ type: 'GAME_READY' }, '*');
        }

        function createBall() {
            ball = new THREE.Mesh(new THREE.SphereGeometry(BALL_RADIUS, 32, 32), new THREE.MeshPhongMaterial({ color: 0xe74c3c }));
            ball.position.set(0, BALL_RADIUS + PLATFORM_SIZE / 2, 0);
            ball.castShadow = true;
            scene.add(ball);
        }

        function initClouds() {
            for (let i = 0; i < 60; i++) {
                const mesh = new THREE.Mesh(new THREE.DodecahedronGeometry(Math.random() * 0.8 + 0.2, 1), new THREE.MeshLambertMaterial({ color: 0xffffff, transparent: true, opacity: 0.8 }));
                mesh.position.set((Math.random() - 0.5) * 120, Math.random() * 30 - 15, (Math.random() - 0.5) * 120);
                scene.add(mesh);
                clouds.push({ mesh, speed: Math.random() * 0.05 + 0.01 });
            }
        }

        function createPlatform(x, y, z) {
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(PLATFORM_SIZE, PLATFORM_SIZE, PLATFORM_SIZE), new THREE.MeshLambertMaterial({ color: 0xe5e8e8 }));
            mesh.position.set(x, y, z);
            mesh.receiveShadow = true;
            scene.add(mesh);
            platforms.push(mesh);
            lastPlatformPos = { x, y, z };

            const shadow = new THREE.Mesh(new THREE.BoxGeometry(PLATFORM_SIZE, PLATFORM_SIZE * 2, PLATFORM_SIZE), new THREE.MeshBasicMaterial({ color: 0xd6eaf8 }));
            shadow.position.set(x, y - PLATFORM_SIZE * 1.5, z);
            scene.add(shadow);
            mesh.userData.shadow = shadow;

            if (Math.random() < 0.15 && platforms.length > 5) {
                const crystal = new THREE.Mesh(new THREE.OctahedronGeometry(0.6), new THREE.MeshPhongMaterial({ color: 0xf1c40f }));
                crystal.position.set(x, y + PLATFORM_SIZE / 2 + 1, z);
                scene.add(crystal);
                crystals.push(crystal);
            }
        }

        function spawnNextPlatform() {
            const isX = Math.random() > 0.5 || platforms.length < 5;
            createPlatform(lastPlatformPos.x + (isX ? PLATFORM_SIZE : 0), 0, lastPlatformPos.z + (isX ? 0 : -PLATFORM_SIZE));
        }

        function handleAction() {
            if (gameState === 'OVER') return;
            audio.init();
            if (gameState === 'START') { gameState = 'PLAYING'; return; }
            direction = direction === 'x' ? 'z' : 'x';
            audio.playNote(400, 'sine');
        }

        function update() {
            if (gameState === 'PLAYING') {
                ball.position[direction] += (direction === 'x' ? 1 : -1) * speed;
                speed += 0.00005;

                targetCameraPos.x = ball.position.x + 20;
                targetCameraPos.z = ball.position.z + 20;
                camera.position.x += (targetCameraPos.x - camera.position.x) * 0.05;
                camera.position.z += (targetCameraPos.z - camera.position.z) * 0.05;

                let onPlatform = false;
                platforms.forEach(p => {
                    if (Math.abs(ball.position.x - p.position.x) < PLATFORM_SIZE / 2 + BALL_RADIUS * 0.3 &&
                        Math.abs(ball.position.z - p.position.z) < PLATFORM_SIZE / 2 + BALL_RADIUS * 0.3) {
                        onPlatform = true;
                    }
                });

                if (!onPlatform) gameOver();

                crystals.forEach((c, i) => {
                    c.rotation.y += 0.05;
                    if (ball.position.distanceTo(c.position) < 1.5) {
                        scene.remove(c); crystals.splice(i, 1);
                        score += 5; audio.playNote(880, 'sine');
                    }
                });

                if (platforms.length > 0 && ball.position.distanceTo(platforms[platforms.length - 1].position) < 30) {
                    spawnNextPlatform();
                }

                score += 0.1;
                document.getElementById('score').textContent = Math.floor(score);
            } else if (gameState === 'OVER') {
                ball.position.y -= 0.5;
            }

            clouds.forEach(c => {
                c.mesh.position.x += c.speed;
                if (c.mesh.position.x > ball.position.x + 60) c.mesh.position.x = ball.position.x - 60;
            });
        }

        function render() { renderer.render(scene, camera); }
        function animate() { requestAnimationFrame(animate); update(); render(); }
        function resize() {
            const aspect = window.innerWidth / window.innerHeight;
            const d = 20;
            camera.left = -d * aspect; camera.right = d * aspect;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function gameOver() {
            if (gameState === 'OVER') return; gameState = 'OVER';
            document.getElementById('game-over').style.display = 'block';
            document.getElementById('final-score').textContent = Math.floor(score);
            audio.playNote(150, 'sawtooth', 0.5, 0.3);
            window.parent.postMessage({ type: 'GAME_OVER', payload: { score: Math.floor(score) } }, '*');
        }

        window.addEventListener('pointerdown', handleAction);
        window.addEventListener('keydown', e => { if (e.code === 'Space') handleAction(); });
        window.addEventListener('resize', resize);
        init();
    </script>
</body>

</html>